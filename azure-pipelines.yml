# https://dev.azure.com/spyder-ide/spyder/

jobs:

################################################################################
# macOS
################################################################################
- job: 'macOS'

  pool:
    vmImage: 'macOS-10.14'

  timeoutInMinutes: 40

  variables:
    USE_CONDA: "yes"
    CI: True
    AZURE: True

  # Run the pipeline with multiple Python versions
  strategy:
    matrix:
      Python27-slow:
        python.version: '2.7'
        run.slow: 'true'
      Python27-fast:
        python.version: '2.7'
        run.slow: 'false'
      Python37-slow:
        python.version: '3.7'
        run.slow: 'true'
      Python37-fast:
        python.version: '3.7'
        run.slow: 'false'
    maxParallel: 4

  steps:

  - bash: echo "##vso[task.prependpath]$CONDA/bin"
    displayName: Add conda to PATH

  - bash: sudo chown -R $USER $CONDA
    displayName: Take ownership of conda installation

  - bash: conda create --yes --quiet --name test
    displayName: Create conda environment

  # Install dependencies
  - script: ./continuous_integration/azure/install.sh
    displayName: 'Install dependencies'
    continueOnError: false

    # Show Conda Build Env
  - script: |
      source activate test
      conda list
    displayName: 'Show build environment'
    continueOnError: true

  - script: |
      source activate test
      check-manifest
    displayName: 'Check manifest for missing files'
    continueOnError: false

    # Run Tests
  - script: |
      ./continuous_integration/azure/runtests.sh || ./continuous_integration/azure/runtests.sh || ./continuous_integration/azure/runtests.sh || ./continuous_integration/azure/runtests.sh
    displayName: 'Run tests'
    continueOnError: false

    # Publish test results to the Azure DevOps server
  - task: PublishTestResults@2
    inputs:
      testResultsFiles: 'result.xml'
      testRunTitle: 'macOS - Python $(python.version)'
      condition: succeededOrFailed()


################################################################################
# Windows
################################################################################
- job: 'Windows'

  pool:
    vmImage: 'vs2017-win2016'

  timeoutInMinutes: 40

  variables:
    CI: True
    AZURE: True
    PYTHON: "C:\\Miniconda"
    CODECOV_TOKEN: "56731c25-9b1f-4340-8b58-35739bfbc52d"

  # Run the pipeline with multiple Python versions
  strategy:
    matrix:
      Python37-slow:
        python.version: '3.7'
        use.conda: 'yes'
        run.slow: 'true'
      Python37-fast:
        python.version: '3.7'
        use.conda: 'yes'
        run.slow: 'false'
    maxParallel: 4

  steps:
  - powershell: Write-Host "##vso[task.prependpath]$env:CONDA\Scripts"
    displayName: Add conda to PATH

  - script: conda update -q -n base conda
    displayName: 'Update conda'

  - script: conda create --yes --quiet --name test python=%PYTHON_VERSION%
    displayName: Create conda environment

    # Install dependencies
  - script: continuous_integration\azure\install.bat
    displayName: 'Install dependencies'
    continueOnError: false

    # Show Conda Build Env
  - script: |
      call activate test
      conda list
    displayName: 'Show build environment'
    continueOnError: true

  - script: |
      call activate test
      check-manifest
    displayName: 'Check manifest'
    continueOnError: false

    # Run Tests
  - script: continuous_integration\azure\runtests.bat
    displayName: 'Run tests'
    continueOnError: false

  - script: |
      call activate test
      codecov
    displayName: 'Run codecov'
    continueOnError: true

    # Publish test results to the Azure DevOps server
  - task: PublishTestResults@2
    inputs:
      testResultsFiles: 'result.xml'
      testRunTitle: 'Windows - Python $(python.version)'
      condition: succeededOrFailed()
